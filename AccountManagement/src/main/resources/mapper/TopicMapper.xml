<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.digitalchina.xa.it.dao.TopicDAO" >
  <sql id="BASE_TABLE">
    t_topic
  </sql>

  <sql id="BASE_COLUMN">
    id,name,type,popularity,available
  </sql>

	<insert id="insert" parameterType="com.digitalchina.xa.it.model.TopicDomain">
		<selectKey resultType="java.lang.Integer" keyProperty="id" order="AFTER">
            select @@IDENTITY as id
        </selectKey>
		INSERT INTO
			<include refid="BASE_TABLE"/>
		<trim prefix="(" suffix=")" suffixOverrides=",">
			name,type,available,
		</trim>
		<trim prefix="VALUES(" suffix=")" suffixOverrides=",">
			#{name, jdbcType=VARCHAR},#{type, jdbcType=VARCHAR},#{available, jdbcType=INTEGER}
		</trim>
	</insert>
	
	<select id="selectTopic" resultType="com.digitalchina.xa.it.model.TopicDomain">
	    SELECT
	      <include refid="BASE_COLUMN"/>
	    FROM
	      <include refid="BASE_TABLE"/>
	</select>
  
	<select id="selectTopicByID" parameterType="com.digitalchina.xa.it.model.TopicDomain" resultType="com.digitalchina.xa.it.model.TopicDomain">
	    SELECT
	      <include refid="BASE_COLUMN"/>
	    FROM
	      <include refid="BASE_TABLE"/>
	     where id = #{id, jdbcType=INTEGER}
	</select>
  
	<update id="updatePopularity" parameterType="com.digitalchina.xa.it.model.TopicDomain">
	   UPDATE 
	   <include refid="BASE_TABLE"/>
	   SET    popularity = popularity+1
	   WHERE  id = #{id, jdbcType=INTEGER}
	</update>
  
  <select id="selectTopicToday" resultType="com.digitalchina.xa.it.model.TopicDomain">
      SELECT
        <include refid="BASE_COLUMN"/>
      FROM
        <include refid="BASE_TABLE"/>
      where available = 1
  </select>
  	<select id="selectNextTopic" resultType="Integer">
      SELECT
        MIN(id)
      FROM
        <include refid="BASE_TABLE"/>
      where available = 0
	</select>
	
  	<update id="updateAvailable" parameterType="com.digitalchina.xa.it.model.TopicDomain">
	   UPDATE 
	   <include refid="BASE_TABLE"/>
	   SET    available = 1
	   WHERE  id = #{id, jdbcType=INTEGER}
	</update>
	
	<update id="updateAvailableBefore" parameterType="com.digitalchina.xa.it.model.TopicDomain">
	   UPDATE 
	   <include refid="BASE_TABLE"/>
	   SET    available = 2
	   WHERE  id = #{id, jdbcType=INTEGER}
	</update>
	
	<update id="updateTopicStatus" parameterType="java.lang.String">
	   UPDATE 
	   <include refid="BASE_TABLE"/>
	   SET    available = 0
	   WHERE  name = #{name, jdbcType=VARCHAR}
	   AND available = 3
	</update>
</mapper>